# HKU n8n Workflow Hub — Project Plan & Spec

## Overview

A static web app for browsing and sharing n8n automation workflows across HKU. Users can preview workflows live, view node details, and import directly into their n8n instance.

**Live URL:** https://white-plant-0018ed200.4.azurestaticapps.net  
**GitHub Repo:** https://github.com/hku-official/hku-n8n-workflow-hub  
**Deployment:** Azure Static Web Apps (auto-deploys on push to `main`)

---

## Architecture

```
┌─────────────────────────┐     ┌──────────────────────┐     ┌──────────────┐
│  React SPA (Vite)       │────▶│  n8n Workflow (API)   │────▶│  Dataverse   │
│  Azure Static Web App   │     │  https://n8n-its.hku.hk    │  (Database)  │
└─────────────────────────┘     └──────────────────────┘     └──────────────┘
```

- **Frontend:** React 18 + Vite + Tailwind CSS, hosted on Azure Static Web Apps
- **Backend API:** n8n workflow with webhook triggers, hosted on `https://n8n-its.hku.hk`
- **Database:** Microsoft Dataverse (tables prefixed `timyeung_`)
- **Workflow Import Target:** `https://n8n-its-dev.hku.hk`

---

## Tech Stack

| Layer       | Technology                                    |
|-------------|-----------------------------------------------|
| Framework   | React 18, Vite 5                              |
| Styling     | Tailwind CSS 3.3                              |
| Icons       | Lucide React                                  |
| HTTP Client | Axios                                         |
| Routing     | React Router DOM 6                            |
| Preview     | `@n8n_io/n8n-demo-component` (CDN web component) |
| Hosting     | Azure Static Web Apps                         |
| CI/CD       | GitHub Actions (auto-generated by Azure)      |
| Backend     | n8n webhook workflows                         |
| Database    | Microsoft Dataverse                           |

---

## Environment Variables

| Variable                | Value                          | Description                        |
|-------------------------|--------------------------------|------------------------------------|
| `VITE_N8N_WEBHOOK_BASE` | `https://n8n-its.hku.hk`     | n8n instance hosting the API workflow |
| `VITE_N8N_IMPORT_BASE`  | `https://n8n-its-dev.hku.hk` | n8n instance for workflow import   |

Set in `.env` locally and in the GitHub Actions workflow for production builds.

---

## API Endpoints (n8n Webhooks)

| Endpoint                       | Method | Params                          | Returns                          |
|--------------------------------|--------|---------------------------------|----------------------------------|
| `/webhook/n8n-flows`           | GET    | `?category=&search=&page=&pageSize=` | `{ flows[], total, page, pageSize, totalPages }` |
| `/webhook/n8n-flows/categories`| GET    | —                               | `{ categories[] }`              |
| `/webhook/n8n-flow`            | GET    | `?id=<GUID>`                    | `{ id, name, description, author, flowJson, tags[], ... }` |

---

## Dataverse Schema

### Table: `timyeung_n8nflows`

| Column                    | Type                  | Description                     |
|---------------------------|-----------------------|---------------------------------|
| `timyeung_n8nflowid`     | GUID (PK)             | Primary key                     |
| `timyeung_name`           | Text (200)            | Workflow name                   |
| `timyeung_description`    | Multiline Text        | Description                     |
| `timyeung_flowjson`       | Multiline Text (max)  | Full n8n workflow JSON          |
| `timyeung_author`         | Text (200)            | Author name                     |
| `timyeung_authorcontact`  | Text (300)            | Author email/URL                |
| `timyeung_category`       | Lookup → `timyeung_n8ncategories` | Category FK       |
| `timyeung_tags`           | Text (500)            | Comma-separated tags            |
| `timyeung_version`        | Text (20)             | Workflow version                |
| `timyeung_n8nversion`     | Text (20)             | Min n8n version required        |
| `timyeung_nodecount`      | Whole Number          | Node count                      |
| `timyeung_viewcount`      | Whole Number          | View count                      |
| `timyeung_downloadcount`  | Whole Number          | Download count                  |
| `timyeung_publishstatus`  | Choice                | Draft/Published/Archived        |

**Choice values for `timyeung_publishstatus`:**
- `101980000` = Draft
- `101980001` = Published
- `101980002` = Archived

**OData category lookup field:** `_timyeung_category_value`

### Table: `timyeung_n8ncategories`

| Column                      | Type         | Description       |
|-----------------------------|--------------|-------------------|
| `timyeung_n8ncategoryid`    | GUID (PK)    | Primary key       |
| `timyeung_name`             | Text (100)   | Category name     |
| `timyeung_description`      | Text (500)   | Description       |
| `timyeung_displayorder`     | Whole Number  | Sort order        |
| `timyeung_icon`             | Text (50)    | Lucide icon name  |

### Table: `timyeung_n8nflowstats` (optional analytics)

| Column                    | Type              | Description       |
|---------------------------|-------------------|-------------------|
| `timyeung_n8nflowstatid`  | GUID (PK)        | Primary key       |
| `timyeung_flowid`         | Lookup → flows    | FK to flow        |
| `timyeung_date`           | Date Only         | Stat date         |
| `timyeung_views`          | Whole Number      | Views on date     |
| `timyeung_downloads`      | Whole Number      | Downloads on date |

---

## n8n Backend Workflow

File: `n8n-workflows/n8n-flow-sharing-api.json`

**Nodes:**
1. **Webhook - List Flows** → Dataverse - List Flows → Transform List Response → Respond
2. **Webhook - List Categories** → Dataverse - List Categories → Transform Categories → Respond
3. **Webhook - Get Flow** → Dataverse - Get Flow → Transform Flow → Respond (+ Increment View Count)

**Key details:**
- Community node type: `n8n-nodes-ms-dataverse.dataverse` (NOT `.microsoftDataverse`)
- Credential key: `dataverseOAuth2Api`
- Table parameter uses `__rl` resource locator pattern: `{ __rl: true, mode: "list", value: "tablename" }`
- Replace `CREDENTIAL_ID` with your actual Dataverse OAuth2 credential ID in n8n

---

## Frontend Structure

```
src/
├── main.jsx              # React entry point
├── App.jsx               # Root layout: Header + Routes + Footer
├── api.js                # Axios API client (listFlows, getFlow, getCategories)
├── index.css             # Tailwind + custom component styles
├── components/
│   ├── Header.jsx        # HKU logo + nav bar (sticky)
│   ├── FlowCard.jsx      # Workflow card for grid listing
│   ├── SearchBar.jsx     # Search input
│   └── CategoryFilter.jsx# Horizontal category pill filter
└── pages/
    ├── HomePage.jsx      # Hero + search + category filter + flow grid
    └── FlowDetailPage.jsx# Full-width preview + nodes list + details sidebar
```

---

## Branding

- **Logo:** Official HKU logo SVG from `https://www.hku.hk/assets/img/hku-115.svg` (saved as `public/hku-logo.svg`)
- **Primary color:** HKU Green `#006747`
- **Theme:** Light background (white/gray-50), green accents, professional serif logo
- **Header:** White with shadow, HKU logo (72px), divider, "n8n Workflow Hub" text
- **Footer:** White with border, HKU logo, "Information Technology Services", copyright
- **Buttons:** `.btn-primary` = HKU green, `.btn-secondary` = white with gray border

---

## Key Features

### Completed
- [x] Project setup (Vite + React + Tailwind)
- [x] Homepage with search, category filter, flow card grid
- [x] Flow detail page with workflow preview (`<n8n-demo>` web component)
- [x] Node list section showing all nodes in a workflow
- [x] Community node detection and dependency warnings (amber badges)
- [x] "Import to n8n" button (URL-encoded JSON → n8n-its-dev.hku.hk)
- [x] Copy JSON + Download JSON buttons
- [x] View count increment on flow detail load
- [x] HKU branding: logo, colors, header, footer
- [x] Light theme matching HKU website style
- [x] Azure Static Web Apps deployment with GitHub Actions CI/CD
- [x] `staticwebapp.config.json` with SPA fallback routing
- [x] GitHub repo under `hku-official` organization

### Pending / Future Enhancements
- [ ] Replace placeholder Dataverse credential ID in workflow JSON with real credential
- [ ] Add authentication (HKU Portal SSO / Azure AD) for submitting workflows
- [ ] Workflow submission form (create new flow records in Dataverse)
- [ ] Admin panel for managing flows (approve/reject/archive)
- [ ] Download count tracking (increment on download button click)
- [ ] Pagination UI on homepage (backend already supports it)
- [ ] Category icons from Dataverse (currently hardcoded list)
- [ ] Custom domain setup for Azure SWA
- [ ] User feedback / rating system
- [ ] Workflow version history
- [ ] Full-text search via Dataverse FetchXML
- [ ] Responsive mobile optimization
- [ ] SEO meta tags and Open Graph

---

## Deployment

### Azure Static Web Apps
- **Workflow file:** `.github/workflows/azure-static-web-apps-white-plant-0018ed200.yml`
- **Secret:** `AZURE_STATIC_WEB_APPS_API_TOKEN_WHITE_PLANT_0018ED200` (auto-configured by Azure)
- **Build:** Vite builds to `dist/`
- **SPA routing:** `staticwebapp.config.json` rewrites 404 → `/index.html`

### To deploy changes
```bash
git add -A && git commit -m "description" && git push origin main
```
Azure auto-builds and deploys in ~1-2 minutes.

---

## Known Issues & Notes

1. **n8n-demo component + community nodes:** Community nodes (e.g., Dataverse) render as `?` icons in the preview. Workaround: Node list section below preview shows all nodes with community badges.
2. **Large workflow import URLs:** Very large workflow JSON may exceed URL length limits for the "Import to n8n" button. Fallback: Download JSON and import manually.
3. **CSP removed:** The Content-Security-Policy header was removed from `staticwebapp.config.json` because it blocked the n8n-demo web component's external resources.
4. **Tailwind `@apply` with custom colors:** Hyphenated custom color names (e.g., `bg-hku-green`) don't work in `@apply` directives. Use plain CSS `background-color: #006747` instead.
5. **IDE lint warnings:** `@tailwind` and `@apply` show as "unknown at rule" in VS Code CSS linting — these are false positives and don't affect the build.
